name: Release and Deploy

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., v1.0.0)'
        required: true
        type: string

env:
  CRYSTAL_VERSION: '1.14.0'

jobs:
  # Build release binaries for multiple platforms
  build-release:
    name: Build Release Binary (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]
        include:
          - os: ubuntu-latest
            artifact_name: crystalcog-linux-x86_64
            binary_path: crystalcog
          - os: macos-latest
            artifact_name: crystalcog-macos-x86_64
            binary_path: crystalcog
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Crystal
      uses: crystal-lang/install-crystal@v1
      with:
        crystal: ${{ env.CRYSTAL_VERSION }}

    - name: Install system dependencies (Ubuntu)
      if: runner.os == 'Linux'
      run: |
        sudo apt-get update
        sudo apt-get install -y libsqlite3-dev librocksdb-dev libevent-dev libssl-dev

    - name: Install system dependencies (macOS)
      if: runner.os == 'macOS'
      run: |
        brew install sqlite3 rocksdb libevent openssl

    - name: Install dependencies
      run: shards install --production

    - name: Build release binary
      run: |
        echo "Building release binary for ${{ matrix.os }}..."
        crystal build --release --static --no-debug src/crystalcog.cr -o ${{ matrix.binary_path }}
        
        # Verify binary
        ls -lh ${{ matrix.binary_path }}
        file ${{ matrix.binary_path }}

    - name: Create tarball
      run: |
        tar -czf ${{ matrix.artifact_name }}.tar.gz ${{ matrix.binary_path }} README.md LICENSE

    - name: Upload release artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: ${{ matrix.artifact_name }}.tar.gz
        retention-days: 30

  # Create GitHub release
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: release-artifacts

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"

    - name: Generate release notes
      run: |
        cat > RELEASE_NOTES.md << 'EOF'
        # CrystalCog ${{ steps.get_version.outputs.version }}
        
        ## What's New
        
        This release includes:
        - Latest bug fixes and improvements
        - Performance optimizations
        - Enhanced stability
        
        ## Installation
        
        Download the appropriate binary for your platform:
        - **Linux**: `crystalcog-linux-x86_64.tar.gz`
        - **macOS**: `crystalcog-macos-x86_64.tar.gz`
        
        Extract and run:
        ```bash
        tar -xzf crystalcog-*.tar.gz
        ./crystalcog --version
        ```
        
        ## Changes
        
        See the [commit history](https://github.com/cogpy/crystalcog/commits/main) for detailed changes.
        
        ## Documentation
        
        - [README](https://github.com/cogpy/crystalcog/blob/main/README.md)
        - [Examples](https://github.com/cogpy/crystalcog/tree/main/examples)
        
        EOF

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.get_version.outputs.version }}
        name: CrystalCog ${{ steps.get_version.outputs.version }}
        body_path: RELEASE_NOTES.md
        draft: false
        prerelease: false
        files: |
          release-artifacts/**/*.tar.gz

  # Build and push Docker image
  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build-release
    permissions:
      contents: read
      packages: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Build and push Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        push: true
        tags: |
          ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }}
          ghcr.io/${{ github.repository }}:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

  # Publish to package registries
  publish-packages:
    name: Publish Packages
    runs-on: ubuntu-latest
    needs: create-release
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Crystal
      uses: crystal-lang/install-crystal@v1
      with:
        crystal: ${{ env.CRYSTAL_VERSION }}

    - name: Publish to Crystal Shards
      run: |
        echo "Package publishing would happen here"
        echo "Note: Crystal doesn't have a central package registry yet"
        echo "Users install via GitHub URL in shard.yml"

  # Deployment notification
  notify:
    name: Deployment Notification
    runs-on: ubuntu-latest
    needs: [create-release, docker-build, publish-packages]
    if: always()
    
    steps:
    - name: Get version
      id: get_version
      run: |
        if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
          VERSION="${{ github.event.inputs.version }}"
        else
          VERSION=${GITHUB_REF#refs/tags/}
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT

    - name: Create deployment summary
      run: |
        echo "# CrystalCog Release ${{ steps.get_version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
        echo "| Build Release | ${{ needs.build-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| GitHub Release | ${{ needs.create-release.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Docker Image | ${{ needs.docker-build.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "| Package Publish | ${{ needs.publish-packages.result }} |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## Release Links" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- [GitHub Release](https://github.com/${{ github.repository }}/releases/tag/${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
        echo "- [Docker Image](https://ghcr.io/${{ github.repository }}:${{ steps.get_version.outputs.version }})" >> $GITHUB_STEP_SUMMARY
